<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OAuth Callback - Cognify</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        .container {
            text-align: center;
            background: rgba(255, 255, 255, 0.1);
            padding: 2rem;
            border-radius: 12px;
            backdrop-filter: blur(10px);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            max-width: 480px;
        }
        .spinner {
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-top: 3px solid white;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .success { color: #4ade80; }
        .error { color: #f87171; }
        .button {
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            cursor: pointer;
            margin-top: 1rem;
            text-decoration: none;
            display: inline-block;
        }
        .button:hover {
            background: rgba(255, 255, 255, 0.3);
        }
        .debug-info {
            font-size: 0.8em;
            opacity: 0.7;
            margin-top: 1rem;
            text-align: left;
            background: rgba(0, 0, 0, 0.2);
            padding: 0.5rem;
            border-radius: 4px;
            white-space: pre-wrap;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="spinner" id="spinner"></div>
        <h1 id="title">Processing OAuth Callback...</h1>
        <p id="message">Please wait while we redirect you back to the app.</p>
        <div id="actions" style="display: none;">
            <a href="#" id="openApp" class="button">Open Cognify App</a>
        </div>
        <div id="debugInfo" class="debug-info" style="display:none"></div>
    </div>

    <script>
        // Toggle to false in production
        const DEBUG_MODE = false;

        const ALLOWED_ORIGINS = [
            'http://localhost',
            'https://localhost',
            'http://127.0.0.1',
            'https://127.0.0.1',
            'cognify'
            // Add production origins here, e.g. 'https://app.yourdomain.com'
        ];
        const MAX_STATE_AGE_MS = 10 * 60 * 1000; // 10 minutes

        // Extract OAuth parameters
        const urlParams = new URLSearchParams(window.location.search);
        const code = urlParams.get('code');
        const encodedState = urlParams.get('state');
        const error = urlParams.get('error');

        // DOM refs
        const spinner = document.getElementById('spinner');
        const title = document.getElementById('title');
        const message = document.getElementById('message');
        const actions = document.getElementById('actions');
        const openAppBtn = document.getElementById('openApp');
        const debugInfo = document.getElementById('debugInfo');

        function debugLog(msg, data) {
            if (!DEBUG_MODE) return;
            const text = `[OAuth Debug] ${msg}${data ? ' ' + JSON.stringify(data, null, 2) : ''}`;
            console.log(text);
            debugInfo.style.display = 'block';
            debugInfo.textContent += text + '\n';
        }

        function updateUI(success, titleText, messageText, showButton = false) {
            spinner.style.display = 'none';
            title.textContent = titleText;
            title.className = success ? 'success' : 'error';
            message.textContent = messageText;
            if (showButton) {
                actions.style.display = 'block';
            }
        }

        function decodeOAuthState(stateParam) {
            if (!stateParam) throw new Error('Missing state parameter');
            debugLog('Decoding state (truncated)', stateParam.substring(0, 32) + '...');

            // Convert Base64URL -> Base64 and pad
            let s = stateParam.replace(/-/g, '+').replace(/_/g, '/');
            while (s.length % 4 !== 0) s += '=';

            const jsonStr = atob(s);
            const data = JSON.parse(jsonStr);

            // Validate fields
            if (!data.randomState || !data.origin || !data.timestamp) {
                throw new Error('State missing required fields');
            }

            // Validate age
            const age = Date.now() - Number(data.timestamp);
            if (Number.isNaN(age) || age > MAX_STATE_AGE_MS) {
                throw new Error(`State too old (${Math.round(age/1000)}s)`);
            }

            // Validate origin
            const allowed = ALLOWED_ORIGINS.some(prefix => data.origin.startsWith(prefix));
            if (!allowed) {
                throw new Error(`Origin not allowed: ${data.origin}`);
            }

            debugLog('State decoded', data);
            return data;
        }

        function storeOAuthResult(key, payload) {
            try {
                localStorage.setItem(key, JSON.stringify(payload));
                debugLog('Stored result to localStorage', { key, payload });
            } catch (e) {
                debugLog('Failed to store result', e.message);
            }
        }

        function redirectToOrigin(stateData) {
            const origin = stateData.origin;
            const platform = stateData.platform || 'web';

            const webUrl = `${origin}/oauth/callback?code=${encodeURIComponent(code)}&state=${encodeURIComponent(encodedState)}`;
            const mobileDeepLink = `cognify://oauth/callback?code=${encodeURIComponent(code)}&state=${encodeURIComponent(encodedState)}`;

            debugLog('Prepared redirect targets', { webUrl, mobileDeepLink, platform });

            // Detect if we're on iOS Safari
            const isIOSSafari = /iP(ad|hone|od)/.test(navigator.userAgent) && 
                              /WebKit/.test(navigator.userAgent) && 
                              !/CriOS|FxiOS|OPiOS|mercury/.test(navigator.userAgent);

            // For iOS Safari, skip automatic redirects and show button immediately
            if (platform === 'ios' || isIOSSafari) {
                debugLog('iOS/Safari detected, showing manual button only');
                updateUI(true, 'Authentication Successful!', 'Please tap the button below to return to Cognify.', true);
                
                // Set up the button with direct href for Safari
                openAppBtn.href = mobileDeepLink;
                openAppBtn.onclick = (e) => {
                    // Let the href handle the navigation
                    // Don't prevent default for iOS
                };
                
                return; // Exit early for iOS
            }

            // For Android, try automatic redirect
            if (platform === 'android') {
                // Android: Try intent first, then custom scheme
                try {
                    window.location.href = `intent://oauth/callback?code=${encodeURIComponent(code)}&state=${encodeURIComponent(encodedState)}#Intent;scheme=cognify;package=com.umerfarooq1995.cognify_flutter;end`;
                } catch (e) {
                    debugLog('Android intent failed, trying custom scheme', e.message);
                    setTimeout(() => {
                        try {
                            window.location.href = mobileDeepLink;
                        } catch (e2) {
                            debugLog('Android custom scheme failed', e2.message);
                        }
                    }, 500);
                }
                
                // Show button as fallback after delay
                setTimeout(() => {
                    updateUI(true, 'Authentication Successful!', 'If the app did not open automatically, use the button below.', true);
                    openAppBtn.onclick = (e) => {
                        e.preventDefault();
                        try { 
                            window.location.href = `intent://oauth/callback?code=${encodeURIComponent(code)}&state=${encodeURIComponent(encodedState)}#Intent;scheme=cognify;package=com.umerfarooq1995.cognify_flutter;end`;
                        } catch (_) {
                            window.location.href = mobileDeepLink;
                        }
                    };
                }, 2000);
            } else {
                // Web platform - redirect to origin
                try {
                    window.location.href = webUrl;
                } catch (e) {
                    debugLog('Web redirect failed', e.message);
                    // Show button as fallback
                    setTimeout(() => {
                        updateUI(true, 'Authentication Successful!', 'If redirect failed, use the button below.', true);
                        openAppBtn.onclick = () => {
                            try { window.location.href = webUrl; } catch (_) {}
                        };
                    }, 2000);
                }
            }
        }

        function handleCallback() {
            debugLog('Starting callback handler', { codeTrunc: code ? code.substring(0, 8) + '...' : null });

            // No need for mobile redirect loop - handle all cases in main flow

            if (error) {
                updateUI(false, 'Authentication Failed', `Error: ${error}`);
                return;
            }
            if (!code || !encodedState) {
                updateUI(false, 'Invalid Callback', 'Missing required OAuth parameters.');
                return;
            }

            let stateData;
            try {
                stateData = decodeOAuthState(encodedState);
            } catch (e) {
                updateUI(false, 'State Error', `Failed to validate callback state: ${e.message}`);
                // Fallback to localhost:3000 to not block dev completely
                setTimeout(() => {
                    const fallbackUrl = `http://localhost:3000/oauth/callback?code=${encodeURIComponent(code)}&state=${encodeURIComponent(encodedState)}`;
                    try { window.location.href = fallbackUrl; } catch (_) {}
                }, 1500);
                return;
            }

            // Optional: store result for polling flows
            storeOAuthResult(`oauth_result_${stateData.randomState}`, {
                status: 'completed',
                state: encodedState,
                code,
                origin: stateData.origin,
                ts: Date.now()
            });

            updateUI(true, 'Authentication Successful!', 'Redirecting back to the app...');
            setTimeout(() => redirectToOrigin(stateData), 500);
        }

        // Kick off
        handleCallback();

        // Auto-close after 30s
        setTimeout(() => { try { window.close(); } catch (_) {} }, 30000);
    </script>
</body>
</html>
